# cloud.jp ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µã‚¤ãƒˆ - ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ç›®çš„: æœ¬ç•ªã¾ãŸã¯ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ã®å•é¡Œç™ºç”Ÿæ™‚ã®è¿…é€Ÿãªå¾©æ—§
# æ‰‹å‹•å®Ÿè¡Œå°‚ç”¨ - ç·Šæ€¥äº‹æ…‹å¯¾å¿œã®ãŸã‚ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
name: Emergency Rollback

# æ‰‹å‹•å®Ÿè¡Œã®ã¿ (ç·Šæ€¥æ™‚å¯¾å¿œ)
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾è±¡ç’°å¢ƒ'
        required: true
        type: choice
        options:
        - staging     # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ
        - production  # æœ¬ç•ªç’°å¢ƒ
      reason:
        description: 'ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç†ç”±'
        required: true
        type: string
      notify_team:
        description: 'ãƒãƒ¼ãƒ é€šçŸ¥'
        required: false
        default: true
        type: boolean

# ç·Šæ€¥å¯¾å¿œç”¨ã®æ¨©é™è¨­å®š
permissions:
  contents: read  # ãƒªãƒã‚¸ãƒˆãƒªå†…å®¹ã®èª­ã¿å–ã‚Š
  issues: write   # ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆè¨˜éŒ²ç”¨ã‚¤ã‚·ãƒ¥ãƒ¼ã®ä½œæˆ
  statuses: write # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯çŠ¶æ³ã®æ›´æ–°

jobs:
  execute-rollback:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}  # é¸æŠã•ã‚ŒãŸç’°å¢ƒã«å¿œã˜ãŸä¿è­·è¨­å®š
    
    steps:
      # ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯é–‹å§‹ãƒ­ã‚°
      # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç†ç”±ã¨å®Ÿè¡Œè€…ã®è¨˜éŒ² (ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ç¢ºä¿)
      - name: ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯é–‹å§‹
        run: |
          echo "ğŸš¨ ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’é–‹å§‹"
          echo "ç’°å¢ƒ: ${{ github.event.inputs.environment }}"
          echo "ç†ç”±: ${{ github.event.inputs.reason }}"
          echo "æ™‚åˆ»: $(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          echo "å®Ÿè¡Œè€…: ${{ github.actor }}"
          
      # ç’°å¢ƒã«å¿œã˜ãŸãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
      # å°‚ç”¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯Webhookã¾ãŸã¯é€šå¸¸ãƒ‡ãƒ—ãƒ­ã‚¤Webhookã‚’ä½¿ç”¨
      - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
        id: rollback
        run: |
          # ç’°å¢ƒã«å¿œã˜ãŸWebhook URL ã®é¸æŠ
          if [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            # æœ¬ç•ªç’°å¢ƒ: å°‚ç”¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ•ãƒƒã‚¯ã¾ãŸã¯é€šå¸¸ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒƒã‚¯
            HOOK_URL="${{ secrets.NETLIFY_PROD_ROLLBACK_HOOK_URL || secrets.NETLIFY_PROD_HOOK_URL }}"
            SITE_URL="https://cloudjp.netlify.app"
          else
            # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ: å°‚ç”¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ•ãƒƒã‚¯ã¾ãŸã¯é€šå¸¸ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒƒã‚¯
            HOOK_URL="${{ secrets.NETLIFY_STAGING_ROLLBACK_HOOK_URL || secrets.NETLIFY_STAGING_HOOK_URL }}"
            SITE_URL="https://staging-cloudjp.netlify.app"
          fi
          
          echo "site_url=$SITE_URL" >> $GITHUB_OUTPUT
          echo "hook_url_used=${HOOK_URL}" >> $GITHUB_OUTPUT
          
          # Netlifyãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
          curl -X POST -d {} "$HOOK_URL"
          echo "ğŸš€ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’é–‹å§‹: $SITE_URL"
          
      # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†ã®ç¢ºèª
      # ã‚µã‚¤ãƒˆã®å¾©æ—§ç¢ºèªã¨ç¨¼åƒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ¤œè¨¼
      - name: å¾…æ©Ÿã¨æ¤œè¨¼
        id: verify
        run: |
          echo "â³ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†ã¾ã§60ç§’å¾…æ©Ÿä¸­..."
          sleep 60  # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†æ™‚é–“ã‚’è€ƒæ…®ã—ãŸå¾…æ©Ÿ
          
          SITE_URL="${{ steps.rollback.outputs.site_url }}"
          MAX_ATTEMPTS=5  # ç·Šæ€¥å¯¾å¿œã®ãŸã‚è©¦è¡Œå›æ•°ã‚’åˆ¶é™
          ATTEMPT=1
          
          # ã‚µã‚¤ãƒˆå¾©æ—§ç¢ºèªãƒ«ãƒ¼ãƒ—
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            if curl -f -s "$SITE_URL" > /dev/null; then
              echo "âœ… ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆåŠŸ - ã‚µã‚¤ãƒˆç¨¼åƒä¸­"
              echo "status=success" >> $GITHUB_OUTPUT
              break
            fi
            
            echo "â³ è©¦è¡Œ $ATTEMPT: ã‚µã‚¤ãƒˆç¢ºèªä¸­..."
            
            # æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ãŸå ´åˆã¯å¤±æ•—ã¨ã™ã‚‹
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "âŒ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œè¨¼å¤±æ•—"
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            ATTEMPT=$((ATTEMPT+1))
            sleep 20  # 20ç§’é–“éš”ã§å†è©¦è¡Œ
          done
          
      # ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆè¨˜éŒ²ç”¨ã‚¤ã‚·ãƒ¥ãƒ¼ã®ä½œæˆ
      # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è©³ç´°ã®è¨˜éŒ²ã¨äº‹å¾Œå¯¾å¿œã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
      - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯èª²é¡Œä½œæˆ
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ steps.verify.outputs.status }}' === 'success';
            const currentTime = new Date('2025-08-21T16:04:43Z').toISOString().replace('T', ' ').slice(0, 19);
            
            // ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆè¨˜éŒ²ç”¨ã‚¤ã‚·ãƒ¥ãƒ¼ã®ä½œæˆ
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ - ${{ github.event.inputs.environment }}`,
              body: `
            ## ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å ±å‘Š
            
            **ç’°å¢ƒ:** ${{ github.event.inputs.environment }}
            **ç†ç”±:** ${{ github.event.inputs.reason }}
            **æ™‚åˆ»:** ${currentTime} UTC
            **å®Ÿè¡Œè€…:** richclaudfelix3019
            **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** ${success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}
            **URL:** ${{ steps.rollback.outputs.site_url }}
            
            ## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            - [ ] ã‚µã‚¤ãƒˆæ©Ÿèƒ½ã‚’æ‰‹å‹•ã§ç¢ºèª
            - [ ] å…ƒã®å•é¡Œã‚’ä¿®æ­£
            - [ ] å†ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã§ä¿®æ­£ã‚’ãƒ†ã‚¹ãƒˆ
            - [ ] ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®äº‹å¾Œåˆ†æã‚’å®Ÿæ–½
            `,
              labels: ['rollback', '${{ github.event.inputs.environment }}', 'incident', 'priority-high']
            });
            
            return issue.data.number;
            
      # ãƒãƒ¼ãƒ é€šçŸ¥ã®é€ä¿¡
      # ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã¸ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†é€šçŸ¥
      - name: ãƒãƒ¼ãƒ é€šçŸ¥
        if: ${{ github.event.inputs.notify_team == 'true' }}
        run: |
          echo "ğŸ“£ ãƒãƒ¼ãƒ ã«é€šçŸ¥ã‚’é€ä¿¡"
          echo "èª²é¡Œç•ªå·: #${{ steps.create-issue.outputs.result }}"
          echo "ç’°å¢ƒ: ${{ github.event.inputs.environment }}"
          echo "URL: ${{ steps.rollback.outputs.site_url }}"
          echo "æ™‚åˆ»: 2025-08-21 16:04:43 UTC"
          echo "å®Ÿè¡Œè€…: richclaudfelix3019"
          
      # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†ã®æœ€çµ‚ç¢ºèª
      # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã®å®Œäº†ã¨ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±ã®æä¾›
      - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†
        run: |
          echo "ğŸ‰ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº† 2025-08-21 16:04:43 UTC"
          echo "ğŸŒ ã‚µã‚¤ãƒˆç¢ºèª: ${{ steps.rollback.outputs.site_url }}"
          echo "ğŸ“ èª²é¡Œç•ªå·: #${{ steps.create-issue.outputs.result }}"