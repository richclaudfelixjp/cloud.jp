name: Emergency Rollback
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾è±¡ç’°å¢ƒ'
        required: true
        type: choice
        options:
        - staging
        - production
      reason:
        description: 'ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç†ç”±'
        required: true
        type: string
      notify_team:
        description: 'ãƒãƒ¼ãƒ é€šçŸ¥'
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  issues: write
  statuses: write

jobs:
  execute-rollback:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯é–‹å§‹
        run: |
          echo "ğŸš¨ ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’é–‹å§‹"
          echo "ç’°å¢ƒ: ${{ github.event.inputs.environment }}"
          echo "ç†ç”±: ${{ github.event.inputs.reason }}"
          echo "æ™‚åˆ»: $(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          echo "å®Ÿè¡Œè€…: ${{ github.actor }}"
          
      - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
        id: rollback
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            # Check for dedicated rollback hook first, otherwise use normal deploy hook
            HOOK_URL="${{ secrets.NETLIFY_PROD_ROLLBACK_HOOK_URL || secrets.NETLIFY_PROD_HOOK_URL }}"
            SITE_URL="https://cloudjp.netlify.app"
          else
            HOOK_URL="${{ secrets.NETLIFY_STAGING_ROLLBACK_HOOK_URL || secrets.NETLIFY_STAGING_HOOK_URL }}"
            SITE_URL="https://staging-cloudjp.netlify.app"
          fi
          
          echo "site_url=$SITE_URL" >> $GITHUB_OUTPUT
          echo "hook_url_used=${HOOK_URL}" >> $GITHUB_OUTPUT
          
          curl -X POST -d {} "$HOOK_URL"
          echo "ğŸš€ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’é–‹å§‹: $SITE_URL"
          
      - name: å¾…æ©Ÿã¨æ¤œè¨¼
        id: verify
        run: |
          echo "â³ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†ã¾ã§60ç§’å¾…æ©Ÿä¸­..."
          sleep 60
          
          SITE_URL="${{ steps.rollback.outputs.site_url }}"
          MAX_ATTEMPTS=5
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            if curl -f -s "$SITE_URL" > /dev/null; then
              echo "âœ… ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆåŠŸ - ã‚µã‚¤ãƒˆç¨¼åƒä¸­"
              echo "status=success" >> $GITHUB_OUTPUT
              break
            fi
            
            echo "â³ è©¦è¡Œ $ATTEMPT: ã‚µã‚¤ãƒˆç¢ºèªä¸­..."
            
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "âŒ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œè¨¼å¤±æ•—"
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            ATTEMPT=$((ATTEMPT+1))
            sleep 20
          done
          
      - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯èª²é¡Œä½œæˆ
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ steps.verify.outputs.status }}' === 'success';
            const currentTime = new Date('2025-08-21T16:04:43Z').toISOString().replace('T', ' ').slice(0, 19);
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ - ${{ github.event.inputs.environment }}`,
              body: `
            ## ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å ±å‘Š
            
            **ç’°å¢ƒ:** ${{ github.event.inputs.environment }}
            **ç†ç”±:** ${{ github.event.inputs.reason }}
            **æ™‚åˆ»:** ${currentTime} UTC
            **å®Ÿè¡Œè€…:** richclaudfelix3019
            **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** ${success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}
            **URL:** ${{ steps.rollback.outputs.site_url }}
            
            ## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            - [ ] ã‚µã‚¤ãƒˆæ©Ÿèƒ½ã‚’æ‰‹å‹•ã§ç¢ºèª
            - [ ] å…ƒã®å•é¡Œã‚’ä¿®æ­£
            - [ ] å†ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã§ä¿®æ­£ã‚’ãƒ†ã‚¹ãƒˆ
            - [ ] ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®äº‹å¾Œåˆ†æã‚’å®Ÿæ–½
            `,
              labels: ['rollback', '${{ github.event.inputs.environment }}', 'incident', 'priority-high']
            });
            
            return issue.data.number;
            
      - name: ãƒãƒ¼ãƒ é€šçŸ¥
        if: ${{ github.event.inputs.notify_team == 'true' }}
        run: |
          echo "ğŸ“£ ãƒãƒ¼ãƒ ã«é€šçŸ¥ã‚’é€ä¿¡"
          echo "èª²é¡Œç•ªå·: #${{ steps.create-issue.outputs.result }}"
          echo "ç’°å¢ƒ: ${{ github.event.inputs.environment }}"
          echo "URL: ${{ steps.rollback.outputs.site_url }}"
          echo "æ™‚åˆ»: 2025-08-21 16:04:43 UTC"
          echo "å®Ÿè¡Œè€…: richclaudfelix3019"
          
      - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†
        run: |
          echo "ğŸ‰ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº† 2025-08-21 16:04:43 UTC"
          echo "ğŸŒ ã‚µã‚¤ãƒˆç¢ºèª: ${{ steps.rollback.outputs.site_url }}"
          echo "ğŸ“ èª²é¡Œç•ªå·: #${{ steps.create-issue.outputs.result }}"