name: Emergency Rollback
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾è±¡ç’°å¢ƒ'
        required: true
        type: choice
        options:
        - staging
        - production
      reason:
        description: 'ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç†ç”±'
        required: true
        type: string

jobs:
  execute-rollback:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯é–‹å§‹
        run: |
          echo "ğŸš¨ ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’é–‹å§‹"
          echo "ç’°å¢ƒ: ${{ github.event.inputs.environment }}"
          echo "ç†ç”±: ${{ github.event.inputs.reason }}"
          echo "æ™‚åˆ»: $(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          echo "å®Ÿè¡Œè€…: ${{ github.actor }}"
          
      - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            curl -X POST -d {} "${{ secrets.NETLIFY_PROD_HOOK_URL }}"
            SITE_URL="https://cloudjp.netlify.app"
          else
            curl -X POST -d {} "${{ secrets.NETLIFY_STAGING_HOOK_URL }}"
            SITE_URL="https://staging-cloudjp.netlify.app"
          fi
          echo "SITE_URL=$SITE_URL" >> $GITHUB_ENV
          echo "ğŸš€ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’é–‹å§‹"
          
      - name: å¾…æ©Ÿã¨æ¤œè¨¼
        run: |
          echo "â³ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†ã¾ã§60ç§’å¾…æ©Ÿä¸­..."
          sleep 60
          
          if curl -f -s $SITE_URL > /dev/null; then
            echo "âœ… ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆåŠŸ - ã‚µã‚¤ãƒˆç¨¼åƒä¸­"
          else
            echo "âŒ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¤±æ•— - ã‚µã‚¤ãƒˆå¿œç­”ãªã—"
            exit 1
          fi
          
      - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯èª²é¡Œä½œæˆ
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ job.status }}' === 'success';
            const currentTime = new Date().toISOString().replace('T', ' ').slice(0, 19);
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ - ${{ github.event.inputs.environment }}`,
              body: `
            ## ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å ±å‘Š
            
            **ç’°å¢ƒ:** ${{ github.event.inputs.environment }}
            **ç†ç”±:** ${{ github.event.inputs.reason }}
            **æ™‚åˆ»:** ${currentTime} UTC
            **å®Ÿè¡Œè€…:** ${{ github.actor }}
            **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** ${success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}
            **URL:** ${process.env.SITE_URL}
            
            ## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            - [ ] ã‚µã‚¤ãƒˆæ©Ÿèƒ½ã‚’æ‰‹å‹•ã§ç¢ºèª
            - [ ] å…ƒã®å•é¡Œã‚’ä¿®æ­£
            - [ ] å†ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã§ä¿®æ­£ã‚’ãƒ†ã‚¹ãƒˆ
            `,
              labels: ['rollback', '${{ github.event.inputs.environment }}', 'incident']
            });
            
      - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†
        run: |
          echo "ğŸ‰ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº† $(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          echo "ğŸŒ ã‚µã‚¤ãƒˆç¢ºèª: $SITE_URL"