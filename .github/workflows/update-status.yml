# cloudjp ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µã‚¤ãƒˆ - ã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ç›®çš„: å¤–éƒ¨Playwrightãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã®ãƒ†ã‚¹ãƒˆçµæœã‚’å—ä¿¡ã—ã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
# Repository Dispatch ã‚¤ãƒ™ãƒ³ãƒˆã«ã‚ˆã‚‹ãƒªãƒã‚¸ãƒˆãƒªé–“é€šä¿¡
name: Update Commit Status

# å¤–éƒ¨ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ (Playwrightãƒ†ã‚¹ãƒˆå®Œäº†é€šçŸ¥)
on:
  repository_dispatch:
    types: [e2e-test-complete]  # Playwrightãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã®E2Eãƒ†ã‚¹ãƒˆå®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆ

# ã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°æ¨©é™
permissions:
  statuses: write  # GitHubã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°

jobs:
  update-status:
    runs-on: ubuntu-latest
    steps:
      # ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰æƒ…å ±ã®æŠ½å‡º
      # Playwrightãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆçµæœã®è§£æ
      - name: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±å–å¾—
        id: payload
        run: |
          echo "commit_sha=${{ github.event.client_payload.commit_sha }}" >> $GITHUB_OUTPUT
          echo "test_result=${{ github.event.client_payload.test_result }}" >> $GITHUB_OUTPUT
          echo "environment=${{ github.event.client_payload.environment }}" >> $GITHUB_OUTPUT
          echo "run_id=${{ github.event.client_payload.run_id }}" >> $GITHUB_OUTPUT
          
      # Playwrightãƒ†ã‚¹ãƒˆçµæœã«åŸºã¥ãã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
      # æˆåŠŸ/å¤±æ•—ã«å¿œã˜ãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ãƒªãƒ³ã‚¯ã®è¨­å®š
      - name: ã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        uses: actions/github-script@v7
        with:
          script: |
            // ãƒ†ã‚¹ãƒˆçµæœã®åˆ¤å®š
            const isSuccess = '${{ steps.payload.outputs.test_result }}' === 'passed';
            const environment = '${{ steps.payload.outputs.environment }}';
            
            // ç’°å¢ƒã«å¿œã˜ãŸã‚µã‚¤ãƒˆURLã®è¨­å®š
            const envUrl = environment === 'production' 
              ? 'https://cloudjp.netlify.app' 
              : 'https://staging-cloudjp.netlify.app';
            
            // æ—¥æœ¬èªã§ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹èª¬æ˜
            const description = `${environment}ç’°å¢ƒã§Playwrightãƒ†ã‚¹ãƒˆ${isSuccess ? 'æˆåŠŸ' : 'å¤±æ•—'}`;
            
            // GitHubã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ steps.payload.outputs.commit_sha }}',
              state: isSuccess ? 'success' : 'failure',
              target_url: `https://github.com/richclaudfelixjp/playwright-project/actions/runs/${{ steps.payload.outputs.run_id }}`,
              description: description,
              context: `cloudjp/${environment}-playwright`  // ç’°å¢ƒåˆ¥ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè­˜åˆ¥
            });
            
            // å®Ÿè¡Œãƒ­ã‚°å‡ºåŠ›
            console.log(`âœ… ã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°: ${environment} ãƒ†ã‚¹ãƒˆçµæœ: ${isSuccess ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
            console.log(`ğŸ“Š å¯¾è±¡ã‚³ãƒŸãƒƒãƒˆ: ${{ steps.payload.outputs.commit_sha }}`);
            console.log(`ğŸ”— ãƒ†ã‚¹ãƒˆè©³ç´°: https://github.com/richclaudfelixjp/playwright-project/actions/runs/${{ steps.payload.outputs.run_id }}`);