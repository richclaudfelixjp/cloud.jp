name: Deploy to Staging
on:
  workflow_run:
    workflows: ["cloudjp CI"]
    branches: [staging]
    types: [completed]
  workflow_dispatch:

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment: staging
    
    steps:
      - name: Netlifyステージング環境にデプロイ
        run: |
          curl -X POST -d {} "${{ secrets.NETLIFY_STAGING_HOOK_URL }}"
          echo "🚀 ステージング環境へのデプロイを開始"
          
      - name: デプロイ完了待機
        run: |
          echo "⏳ デプロイ完了を待機中..."
          sleep 45
          
          for i in {1..12}; do
            if curl -f -s https://staging-cloudjp.netlify.app > /dev/null; then
              echo "✅ ステージングサイトが稼働中!"
              break
            fi
            echo "⏳ 試行 $i: サイト準備中、待機中..."
            sleep 10
          done
          
      - name: Playwrightテスト実行
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PLAYWRIGHT_REPO_TOKEN }}
          repository: richclaudfelixjp/Playwright-Project
          event-type: cloudjp-test
          client-payload: |
            {
              "environment": "staging",
              "url": "https://staging-cloudjp.netlify.app",
              "commit_sha": "${{ github.sha }}",
              "branch": "${{ github.ref_name }}"
            }
            
      - name: コミットステータス更新
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'pending',
              target_url: 'https://staging-cloudjp.netlify.app',
              description: 'ステージング環境でPlaywrightテスト実行中',
              context: 'cloudjp/staging-playwright'
            });