name: Deploy to Staging
on:
  workflow_run:
    workflows: ["cloudjp CI"]
    branches: [staging]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read
  deployments: write
  statuses: write

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment: staging
    
    steps:
      - name: „Éá„Éó„É≠„Ç§ÈñãÂßãË®òÈå≤
        run: |
          echo "üöÄ „Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞Áí∞Â¢É„Å∏„ÅÆ„Éá„Éó„É≠„Ç§„ÇíÈñãÂßã"
          echo "‚è∞ ÈñãÂßãÊôÇÈñì: $(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          echo "üë§ ÂÆüË°åËÄÖ: ${{ github.actor }}"
          
      - name: Netlify„Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞Áí∞Â¢É„Å´„Éá„Éó„É≠„Ç§
        id: deploy
        run: |
          DEPLOY_RESULT=$(curl -X POST -d {} "${{ secrets.NETLIFY_STAGING_HOOK_URL }}" -s)
          echo "deploy_id=$(date +%s)" >> $GITHUB_OUTPUT
          echo "üîó „Éá„Éó„É≠„Ç§URL: https://staging-cloudjp.netlify.app"
          
      - name: „Éá„Éó„É≠„Ç§ÂÆå‰∫ÜÂæÖÊ©ü
        id: verify
        run: |
          echo "‚è≥ „Éá„Éó„É≠„Ç§ÂÆå‰∫Ü„ÇíÂæÖÊ©ü‰∏≠..."
          sleep 45
          
          MAX_ATTEMPTS=12
          ATTEMPT=1
          SITE_URL="https://staging-cloudjp.netlify.app"
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            if curl -f -s "$SITE_URL" > /dev/null; then
              echo "‚úÖ „Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞„Çµ„Ç§„Éà„ÅåÁ®ºÂÉç‰∏≠!"
              echo "status=success" >> $GITHUB_OUTPUT
              break
            fi
            
            echo "‚è≥ Ë©¶Ë°å $ATTEMPT: „Çµ„Ç§„ÉàÊ∫ñÂÇô‰∏≠„ÄÅÂæÖÊ©ü‰∏≠..."
            
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "‚ùå „Éá„Éó„É≠„Ç§Ê§úË®º„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            ATTEMPT=$((ATTEMPT+1))
            sleep 10
          done
          
      - name: Playwright„ÉÜ„Çπ„ÉàÂÆüË°å
        if: steps.verify.outputs.status == 'success'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PLAYWRIGHT_REPO_TOKEN }}
          repository: richclaudfelixjp/Playwright-Project
          event-type: cloudjp-test
          client-payload: |
            {
              "environment": "staging",
              "url": "https://staging-cloudjp.netlify.app",
              "commit_sha": "${{ github.sha }}",
              "branch": "${{ github.ref_name }}",
              "triggered_by": "${{ github.actor }}"
            }
            
      - name: „Ç≥„Éü„ÉÉ„Éà„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'pending',
              target_url: 'https://staging-cloudjp.netlify.app',
              description: '„Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞Áí∞Â¢É„ÅßPlaywright„ÉÜ„Çπ„ÉàÂÆüË°å‰∏≠',
              context: 'cloudjp/staging-playwright'
            });