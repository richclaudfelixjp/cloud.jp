# cloudjp ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µã‚¤ãƒˆ - ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ç›®çš„: stagingãƒ–ãƒ©ãƒ³ãƒã®å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ (staging-cloudjp.netlify.app) ã«ãƒ‡ãƒ—ãƒ­ã‚¤
# æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®æœ€çµ‚æ¤œè¨¼ã¨Playwrightãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
name: Deploy to Staging

# ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶
on:
  push:
    branches: [staging]  # stagingãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚
  workflow_dispatch:     # æ‰‹å‹•å®Ÿè¡Œ (ãƒ†ã‚¹ãƒˆç›®çš„)

# GitHubæ¨©é™è¨­å®š: ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒç”¨ã®æœ€å°æ¨©é™
permissions:
  contents: read      # ãƒªãƒã‚¸ãƒˆãƒªå†…å®¹ã®èª­ã¿å–ã‚Š
  deployments: write  # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨˜éŒ²ã®ä½œæˆ
  statuses: write     # ã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
    environment: staging  # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒä¿è­·è¨­å®šã‚’é©ç”¨
    
    steps:
      # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹ãƒ­ã‚°
      # ãƒ‡ãƒ—ãƒ­ã‚¤ã®é–‹å§‹æ™‚åˆ»ã¨ãƒˆãƒªã‚¬ãƒ¼æƒ…å ±ã‚’è¨˜éŒ²
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹è¨˜éŒ²
        run: |
          echo "ğŸš€ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹"
          echo "â° é–‹å§‹æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S') UTC"
          echo "ğŸ‘¤ å®Ÿè¡Œè€…: ${{ github.actor }}"
          
      # Netlifyã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
      # Webhookãƒˆãƒªã‚¬ãƒ¼ã«ã‚ˆã‚‹Netlifyã®ãƒ“ãƒ«ãƒ‰&ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹
      - name: Netlifyã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deploy
        run: |
          DEPLOY_RESULT=$(curl -X POST -d {} "${{ secrets.NETLIFY_STAGING_HOOK_URL }}" -s)
          echo "deploy_id=$(date +%s)" >> $GITHUB_OUTPUT  # ãƒ‡ãƒ—ãƒ­ã‚¤IDã‚’ä¸€æ„ç”Ÿæˆ
          echo "ğŸ”— ãƒ‡ãƒ—ãƒ­ã‚¤URL: https://staging-cloudjp.netlify.app"
          
      # ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã®ç¢ºèªã¨ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      # Netlifyãƒ“ãƒ«ãƒ‰å®Œäº†ã¨ã‚µã‚¤ãƒˆç¨¼åƒã®ç¢ºèª
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾…æ©Ÿ
        id: verify
        run: |
          echo "â³ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’å¾…æ©Ÿä¸­..."
          sleep 45  # Netlifyãƒ“ãƒ«ãƒ‰æ™‚é–“ã‚’è€ƒæ…®ã—ãŸåˆæœŸå¾…æ©Ÿ
          
          MAX_ATTEMPTS=12    # æœ€å¤§è©¦è¡Œå›æ•° (åˆè¨ˆ2åˆ†é–“)
          ATTEMPT=1
          SITE_URL="https://staging-cloudjp.netlify.app"  # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã‚µã‚¤ãƒˆURL
          
          # ã‚µã‚¤ãƒˆã®ç¨¼åƒç¢ºèªãƒ«ãƒ¼ãƒ—
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            if curl -f -s "$SITE_URL" > /dev/null; then
              echo "âœ… ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã‚µã‚¤ãƒˆãŒç¨¼åƒä¸­!"
              echo "status=success" >> $GITHUB_OUTPUT
              break
            fi
            
            echo "â³ è©¦è¡Œ $ATTEMPT: ã‚µã‚¤ãƒˆæº–å‚™ä¸­ã€å¾…æ©Ÿä¸­..."
            
            # æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ãŸå ´åˆã¯å¤±æ•—ã¨ã™ã‚‹
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ"
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            ATTEMPT=$((ATTEMPT+1))
            sleep 10  # 10ç§’é–“éš”ã§å†è©¦è¡Œ
          done
          
      # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ã®E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      # å¤–éƒ¨Playwrightãƒªãƒã‚¸ãƒˆãƒªã«ã‚ˆã‚‹ãƒ•ãƒ«E2Eãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã®å®Ÿè¡Œ
      - name: Playwrightã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        if: steps.verify.outputs.status == 'success'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PLAYWRIGHT_REPO_TOKEN }}      # Playwrightãƒªãƒã‚¸ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹ç”¨ãƒˆãƒ¼ã‚¯ãƒ³
          repository: richclaudfelixjp/playwright-project  # å¤–éƒ¨ãƒ†ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒª
          event-type: cloudjp-test
          client-payload: |
            {
              "environment": "staging",
              "url": "https://staging-cloudjp.netlify.app",
              "commit_sha": "${{ github.sha }}",
              "branch": "${{ github.ref_name }}",
              "triggered_by": "${{ github.actor }}"
            }
            
      # Playwrightãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ã®ä¸€æ™‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
      # ãƒ†ã‚¹ãƒˆå®Œäº†ã¾ã§ã¯pendingã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨­å®š
      - name: ã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–° (ä¸€æ™‚)
        uses: actions/github-script@v7
        with:
          script: |
            // Playwrightãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ã®ä¸€æ™‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'pending',
              target_url: 'https://staging-cloudjp.netlify.app',
              description: 'ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§Playwrightãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­',
              context: 'cloudjp/staging-playwright'
            });