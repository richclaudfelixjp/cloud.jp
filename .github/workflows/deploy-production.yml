name: Deploy to Production
on:
  repository_dispatch:
    types: [staging-tests-passed]
  workflow_dispatch:

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤æ¡ä»¶æ¤œè¨¼
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "âœ… E2Eãƒ†ã‚¹ãƒˆæˆåŠŸã«ã‚ˆã‚Šè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹"
          else
            echo "âœ… æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãŒè¦æ±‚ã•ã‚Œã¾ã—ãŸ"
          fi

      - name: Netlifyæœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
        run: |
          curl -X POST -d {} "${{ secrets.NETLIFY_PROD_HOOK_URL }}"
          echo "ğŸš€ æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹"
          
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾…æ©Ÿ
        run: |
          echo "â³ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’å¾…æ©Ÿä¸­..."
          sleep 45
          
          for i in {1..12}; do
            if curl -f -s https://cloudjp.netlify.app > /dev/null; then
              echo "âœ… æœ¬ç•ªã‚µã‚¤ãƒˆãŒç¨¼åƒä¸­!"
              break
            fi
            echo "â³ è©¦è¡Œ $i: ã‚µã‚¤ãƒˆæº–å‚™ä¸­ã€å¾…æ©Ÿä¸­..."
            sleep 10
          done
          
      - name: æœ¬ç•ªç’°å¢ƒæ¤œè¨¼ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PLAYWRIGHT_REPO_TOKEN }}
          repository: richclaudfelixjp/Playwright-Project
          event-type: cloudjp-test
          client-payload: |
            {
              "environment": "production",
              "url": "https://cloudjp.netlify.app",
              "commit_sha": "${{ github.sha }}",
              "branch": "${{ github.ref_name }}",
              "verification_only": true
            }
            
      - name: ã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        uses: actions/github-script@v7
        with:
          script: |
            const sha = '${{ github.event.client_payload.commit_sha }}' || '${{ github.sha }}';
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: sha,
              state: 'success',
              target_url: 'https://cloudjp.netlify.app',
              description: 'æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸å®Œäº†',
              context: 'cloudjp/successful-deployment'
            });
            
      - name: æˆåŠŸé€šçŸ¥é€ä¿¡
        run: |
          echo "ğŸ‰ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸å®Œäº†!"
          echo "ğŸŒ å…¬é–‹ã‚µã‚¤ãƒˆ: https://cloudjp.netlify.app"
          echo "ğŸ“Š ã‚³ãƒŸãƒƒãƒˆ: ${{ github.event.client_payload.commit_sha || github.sha }}"
          echo "ğŸ”— ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
          echo "ğŸ‘¤ ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œè€…: ${{ github.actor }}"
          echo "â° ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»: $(date -u)"