# cloudjp ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µã‚¤ãƒˆ - æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ç›®çš„: masterãƒ–ãƒ©ãƒ³ãƒã®å¤‰æ›´ã‚’æœ¬ç•ªç’°å¢ƒ (cloudjp.netlify.app) ã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
# Netlify Webhookã‚’ä½¿ç”¨ã—ãŸã‚¼ãƒ­ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
name: Deploy to Production

# ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶
on:
  push:
    branches: [master]  # masterãƒ–ãƒ©ãƒ³ãƒã¸ã®ç›´æ¥ãƒ—ãƒƒã‚·ãƒ¥æ™‚
  workflow_dispatch:    # æ‰‹å‹•å®Ÿè¡Œ (ç·Šæ€¥ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨)

# GitHubæ¨©é™è¨­å®š: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’è€ƒæ…®ã—ãŸæœ€å°æ¨©é™ã®åŸå‰‡
permissions:
  contents: read      # ãƒªãƒã‚¸ãƒˆãƒªå†…å®¹ã®èª­ã¿å–ã‚Š
  deployments: write  # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨˜éŒ²ã®ä½œæˆ
  statuses: write     # ã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°
  issues: write       # ãƒ‡ãƒ—ãƒ­ã‚¤è¨˜éŒ²ç”¨ã‚¤ã‚·ãƒ¥ãƒ¼ã®ä½œæˆ

jobs:
  deploy-production:
    name: æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    environment: production  # æœ¬ç•ªç’°å¢ƒä¿è­·è¨­å®šã‚’é©ç”¨
    
    steps:
      # ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹ãƒ­ã‚°è¨˜éŒ²
      # è‡ªå‹•ãƒ»æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã®åˆ¤åˆ¥ã¨ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ç¢ºä¿
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤æ¡ä»¶æ¤œè¨¼
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "âœ… Master branchã¸ã®ãƒãƒ¼ã‚¸ã«ã‚ˆã‚Šè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹"
          else
            echo "âœ… æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãŒè¦æ±‚ã•ã‚Œã¾ã—ãŸ"
          fi
          echo "â° ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹: $(date -u '+%Y-%m-%d %H:%M:%S') UTC"

      # Netlifyæœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
      # Webhookãƒˆãƒªã‚¬ãƒ¼ã«ã‚ˆã‚‹Netlifyã®ãƒ“ãƒ«ãƒ‰&ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹
      - name: Netlifyæœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deploy
        run: |
          DEPLOY_RESULT=$(curl -X POST -d {} "${{ secrets.NETLIFY_PROD_HOOK_URL }}" -s)
          echo "deploy_id=$(date +%s)" >> $GITHUB_OUTPUT  # ãƒ‡ãƒ—ãƒ­ã‚¤IDã‚’ä¸€æ„ç”Ÿæˆ
          echo "ğŸš€ æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹"
          
      # ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã®ç¢ºèªã¨ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      # Netlifyã®ãƒ“ãƒ«ãƒ‰æ™‚é–“ã‚’è€ƒæ…®ã—ãŸå¾…æ©Ÿã¨ã‚µã‚¤ãƒˆç¨¼åƒç¢ºèª
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾…æ©Ÿ
        id: verify
        run: |
          echo "â³ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’å¾…æ©Ÿä¸­..."
          sleep 45  # Netlifyãƒ“ãƒ«ãƒ‰æ™‚é–“ã‚’è€ƒæ…®ã—ãŸåˆæœŸå¾…æ©Ÿ
          
          MAX_ATTEMPTS=12    # æœ€å¤§è©¦è¡Œå›æ•° (åˆè¨ˆ2åˆ†é–“)
          ATTEMPT=1
          SITE_URL="https://cloudjp.netlify.app"  # æœ¬ç•ªã‚µã‚¤ãƒˆURL
          
          # ã‚µã‚¤ãƒˆã®ç¨¼åƒç¢ºèªãƒ«ãƒ¼ãƒ—
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            if curl -f -s "$SITE_URL" > /dev/null; then
              echo "âœ… æœ¬ç•ªã‚µã‚¤ãƒˆãŒç¨¼åƒä¸­!"
              echo "status=success" >> $GITHUB_OUTPUT
              break
            fi
            
            echo "â³ è©¦è¡Œ $ATTEMPT: ã‚µã‚¤ãƒˆæº–å‚™ä¸­ã€å¾…æ©Ÿä¸­..."
            
            # æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ãŸå ´åˆã¯å¤±æ•—ã¨ã™ã‚‹
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ"
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            ATTEMPT=$((ATTEMPT+1))
            sleep 10  # 10ç§’é–“éš”ã§å†è©¦è¡Œ
          done
          
      # æœ¬ç•ªç’°å¢ƒã§ã®E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      # å¤–éƒ¨Playwrightãƒªãƒã‚¸ãƒˆãƒªã«ã‚ˆã‚‹E2Eè‡ªå‹•ãƒ†ã‚¹ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼
      - name: æœ¬ç•ªç’°å¢ƒæ¤œè¨¼ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        if: steps.verify.outputs.status == 'success'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PLAYWRIGHT_REPO_TOKEN }}      # Playwrightãƒªãƒã‚¸ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹ç”¨ãƒˆãƒ¼ã‚¯ãƒ³
          repository: richclaudfelixjp/playwright-project  # å¤–éƒ¨ãƒ†ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒª
          event-type: cloudjp-test
          client-payload: |
            {
              "environment": "production",
              "url": "https://cloudjp.netlify.app",
              "commit_sha": "${{ github.sha }}",
              "branch": "${{ github.ref_name }}",
              "verification_only": true,
              "triggered_by": "${{ github.actor }}"
            }
            
      # ãƒ‡ãƒ—ãƒ­ã‚¤å±¥æ­´ã®è¨˜éŒ²
      # GitHubã‚¤ã‚·ãƒ¥ãƒ¼ã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤è©³ç´°ã‚’è¨˜éŒ²ã—ã€ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã‚’ç¢ºä¿
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤è¨˜éŒ²ä½œæˆ
        uses: actions/github-script@v7
        with:
          script: |
            const sha = '${{ github.sha }}';
            const timestamp = new Date().toISOString();
            
            // ãƒ‡ãƒ—ãƒ­ã‚¤è¨˜éŒ²ç”¨ã‚¤ã‚·ãƒ¥ãƒ¼ã®ä½œæˆ
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“¦ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ - ${timestamp.split('T')[0]}`,
              body: `
            ## æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤è©³ç´°
            
            **ãƒ‡ãƒ—ãƒ­ã‚¤ID:** ${{ steps.deploy.outputs.deploy_id }}
            **ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»:** ${timestamp}
            **å®Ÿè¡Œè€…:** ${{ github.actor }}
            **ã‚³ãƒŸãƒƒãƒˆ:** ${sha}
            **URL:** https://cloudjp.netlify.app
            
            ### æ¤œè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
            - æœ¬ç•ªæ¤œè¨¼ãƒ†ã‚¹ãƒˆ: å®Ÿè¡Œä¸­
            
            ### é–¢é€£å¤‰æ›´
            - ${sha}
            `,
              labels: ['deployment', 'production']  // ãƒ©ãƒ™ãƒ«ã«ã‚ˆã‚‹åˆ†é¡
            });
            
      # GitHubã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°
      # PRã‚„ã‚³ãƒŸãƒƒãƒˆç”»é¢ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³å¯è¦–åŒ–
      - name: ã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        uses: actions/github-script@v7
        with:
          script: |
            const sha = '${{ github.sha }}';
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: sha,
              state: 'success',
              target_url: 'https://cloudjp.netlify.app',
              description: 'æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸å®Œäº†',
              context: 'cloudjp/production-deployment'
            });
            
      # ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸã®æœ€çµ‚ç¢ºèªãƒ­ã‚°
      # ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã®ç¢ºèªã¨é–¢é€£æƒ…å ±ã®è¨˜éŒ²
      - name: æˆåŠŸé€šçŸ¥é€ä¿¡
        run: |
          echo "ğŸ‰ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸å®Œäº†!"
          echo "ğŸŒ å…¬é–‹ã‚µã‚¤ãƒˆ: https://cloudjp.netlify.app"
          echo "ğŸ“Š ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          echo "ğŸ”— ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
          echo "ğŸ‘¤ ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œè€…: ${{ github.actor }}"
          echo "â° ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»: $(date -u)"